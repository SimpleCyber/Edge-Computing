{% extends "../base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Column - Data Input Form -->
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between">
                    <h4>Simulate Device Data Input</h4>
                    <a href="{% url 'dashboard' %}" class="btn btn-sm btn-light">Back to Dashboard</a>
                </div>
                
                <!-- Data Input Form -->
                <div class="card-body">
                    <form method="post" id="dataForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="device_id" class="form-label">Select Device</label>
                            <select class="form-select" id="device_id" name="device_id" required>
                                <option value="">-- Select a Device --</option>
                                {% for device in devices %}
                                    <option value="{{ device.id }}">{{ device.name }} ({{ device.device_type }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoGenerate" name="auto_generate">
                                <label class="form-check-label" for="autoGenerate">Auto-generate multiple records</label>
                            </div>
                        </div>
                        
                        <div id="manualInput" class="mb-3">
                            <label for="data_type" class="form-label">Data Type</label>
                            <select class="form-select" id="data_type" name="data_type">
                                <option value="temperature">Temperature</option>
                                <option value="humidity">Humidity</option>
                                <option value="pressure">Pressure</option>
                                <option value="random">Random Value</option>
                            </select>
                        </div>
                        
                        <div id="autoInput" class="mb-3" style="display: none;">
                            <label for="num_records" class="form-label">Number of records to generate</label>
                            <input type="number" class="form-control" id="num_records" name="num_records" value="10" min="1" max="100">
                            <div class="form-text">Random data types will be generated</div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">Submit Data</button>
                            <button type="button" id="generateApiBtn" class="btn btn-info">Generate via API</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column - Data History Section -->
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5>Recent Data History</h5>
                </div>
                <div class="card-body">
                    {% if recent_data %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Timestamp</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in recent_data %}
                                <tr>
                                    <td>{{ data.device.name }}</td>
                                    <td>{{ data.data.type|title }}</td>
                                    <td>{{ data.data.value }} {{ data.data.unit }}</td>
                                    <td>{{ data.timestamp|date:"Y-m-d H:i:s" }}</td>
                                    <td>
                                        {% if data.is_processed %}
                                            <span class="badge bg-success">Processed</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No data history available yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const autoGenerate = document.getElementById('autoGenerate');
    const manualInput = document.getElementById('manualInput');
    const autoInput = document.getElementById('autoInput');
    const generateApiBtn = document.getElementById('generateApiBtn');
    
    // Toggle between manual and auto input
    autoGenerate.addEventListener('change', function() {
        manualInput.style.display = this.checked ? 'none' : 'block';
        autoInput.style.display = this.checked ? 'block' : 'none';
    });
    
    // Handle API generation
    generateApiBtn.addEventListener('click', function() {
        const deviceSelect = document.getElementById('device_id');
        if (!deviceSelect.value) {
            alert('Please select a device first');
            deviceSelect.focus();
            return;
        }
        
        const numRecords = document.getElementById('num_records')?.value || 10;
        
        fetch('/api/generate-data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                device_id: deviceSelect.value,
                num_records: numRecords
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'Request failed'); });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            window.location.reload(); // Refresh to show new data
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    });
});
</script>
{% endblock %}